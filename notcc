#!/bin/bash

if [[ $(docker images -q notc) == "" ]]; then
    echo "Docker image missing. Build it now?"
    select ans in "Yes" "No"; do
        case $ans in
            Yes ) docker build -t notc .; break;;
            No  ) exit 0
        esac
    done
fi

if [[ $# -ne 1 ]]; then
    echo "Usage: ./notcc <source file>" >&2
    exit 1
fi

if [[ ! -f $1 ]]; then
    echo "$1: No such file" >&2
    exit 1
fi

src_file=$(basename "$1")
src_path=""

# Figure out full path of source file
if [[ $1 == /* ]]; then
    src_path=$1
elif [[ $1 == *"/"* ]]; then
    src_path=$(pwd)/$1
else
    src_path=$(pwd)/$src_file
fi

# Replace extension in generated file
out_file=${src_file%.*}.output

touch "$out_file"

# Run compiler with input and output files bind-mounted
docker run -v "$src_path:/compiler_root/$src_file" \
           -v "$(pwd)/$out_file:/compiler_root/$out_file" \
           --rm notc "$src_file"

if [[ $? -ne 0 ]]; then
    rm "$out_file"
fi
